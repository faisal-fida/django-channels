<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Djangochat</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      .messages {
        height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>

  <body class="bg-teal-600">
    <nav class="flex items-center justify-between px-4 py-6 bg-teal-800">
      <div>
        <a href="/" class="text-xl text-white">Djangochat</a>
      </div>

      <div class="flex items-center space-x-4">
        <a href="/rooms/" class="text-white hover:text-gray-200">Rooms</a>
      </div>
    </nav>
    <div class="p-10 lg:p-20 text-center">
      <h1 class="text-3xl lg:text-6xl text-white">{{ room.name }}</h1>
    </div>

    <div class="lg:w-2/4 mx-4 lg:mx-auto p-4 bg-white rounded-xl">
      <div class="chat-messages space-y-3" id="chat-messages">
        {% for m in messages %}<b> </b>: {{ m.content }}<br />{% endfor %}
      </div>
    </div>

    <div class="lg:w-2/4 mt-6 mx-4 lg:mx-auto p-4 bg-white rounded-xl">
      <form method="post" action="." class="flex">
        {% csrf_token %}
        <input
          type="text"
          name="content"
          class="flex-1 mr-3"
          placeholder="Your message..."
          id="chat-message-input"
        />

        <button
          class="px-5 py-3 rounded-xl text-white bg-teal-600 hover:bg-teal-700"
          id="chat-message-submit"
        >
          Submit
        </button>
      </form>
    </div>

    <script>
      const roomName = JSON.parse(
        document.getElementById("json-roomname").textContent
      );
      const userName = JSON.parse(
        document.getElementById("json-username").textContent
      );
      const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/" + roomName + "/"
      );

      chatSocket.onclose = function (e) {
        console.log("onclose");
      };

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.message) {
          document.querySelector("#chat-messages").innerHTML +=
            "<b>" + "</b>: " + data.message + "<br>";
        } else {
          alert("The message was empty!");
        }

        scrollToBottom();
      };

      document.querySelector("#chat-message-input").focus();
      document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.keyCode === 13) {
          document.querySelector("#chat-message-submit").click();
        }
      };

      document.querySelector("#chat-message-submit").onclick = function (e) {
        e.preventDefault();

        const messageInputDom = document.querySelector("#chat-message-input");
        const message = messageInputDom.value;

        console.log({
          message: message,
          username: userName,
          room: roomName,
        });

        chatSocket.send(
          JSON.stringify({
            message: message,
            username: userName,
            room: roomName,
          })
        );

        messageInputDom.value = "";

        return false;
      };

      /**
       * A function for finding the messages element, and scroll to the bottom of it.
       */
      function scrollToBottom() {
        let objDiv = document.getElementById("chat-messages");
        objDiv.scrollTop = objDiv.scrollHeight;
      }

      // Add this below the function to trigger the scroll on load.
      scrollToBottom();
    </script>
  </body>
</html>
